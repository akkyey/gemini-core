# エージェント行動規範 (Agent Behavior Protocol)

## 1. 原則とエージェントスキル (Principles & Agent Skills)

本プロジェクトでは、定型的な作業の品質とルール遵守を保証するため、**「エージェントスキル (Agent Skills)」の使用を義務付けている。**
エージェントは、以下の状況下では**必ず対応するスキルを使用し、その手順に従うこと。**

また、スキルを使用する際は、タスクの冒頭で以下のように**明示的に宣言**すること。
> 🤖 **【スキル発動】 `skill_name`**

### スキルの改善と新規提案 (Continuous Improvement)

作業を通じて「この手順はスキル化した方が効率的だ」や「既存スキルの手順に不備がある」と気づいた場合、**積極的にユーザーへ改善や新規作成を提案すること。**
現状維持に満足せず、開発プロセスの進化に貢献せよ。

### 必須使用スキル一覧 (Mandatory Skills)

状況に応じて、以下のスキルの使用を徹底すること。
各スキルの詳細は `.agent/skills/<skill_name>/SKILL.md` を参照せよ。

1.  **機能実装・修正 (`feat_implementer`):**
    *   **用途:** 新機能実装、バグ修正、ドキュメント作成。
    *   **カバー範囲:** ブランチ作成、計画書(Plan)、承認フロー、実装、履歴記録(History)、自己診断。

2.  **品質管理・テスト (`quality_guard`):**
    *   **用途:** カバレッジ向上、Lintエラー修正、静的解析。
    *   **カバー範囲:** `pytest` (Coverage), `ruff`, `black`, `mypy`, `flake8`。

3.  **不具合報告 (`trouble_reporter`):**
    *   **用途:** エラー、テスト失敗、バグ検知時。
    *   **カバー範囲:** 自動修正の禁止、レポート作成(`trouble/`)、指示待ちフロー。

4.  **整合性検証 (`integrity_verifier`):**
    *   **用途:** リファクタリング、ロジック変更、パフォーマンス改善。
    *   **カバー範囲:** 変更前後の出力完全一致確認（Diffチェック）。

5.  **コンテキスト同期 (`context_syncer`):**
    *   **用途:** タスク完了時、ドキュメント整備。
    *   **カバー範囲:** `full_context` 生成、`task.md` / `backlog.md` 更新、アーカイブ処理。

6.  **Gitコミット (`git_committer`):**
    *   **用途:** リポジトリへの変更保存。
    *   **カバー範囲:** シェルインジェクション防止（一時ファイル使用）、メッセージ規約遵守。

7.  **品質ゲートキーパー (`quality_gatekeeper`):**
    *   **用途:** コミット前の品質検閲。
    *   **カバー範囲:** Radonによる複雑度(CC)・保守性(MI)の計測、リファクタリング勧告。

### 1.1 禁止事項とアンチパターン (Prohibited Actions & Anti-Patterns)

以下の行為は、プロジェクトの品質と安全性を著しく損なうため、**例外なく禁止する。**

1.  **Gitコマンドの直接実行禁止 (No Direct Git Commit):**
    *   `run_command` 等を使って `git commit -m ...` を直接実行してはならない。必ず `git_committer` スキルの手順（一時ファイル作成等）を経由すること。
2.  **シェルコマンドの直接実行禁止 (No Direct Shell Execution):**
    *   通常のシェルコマンド（`ls`, `grep`, `pytest` 等）を実行する際は、原則として `safe-shell` ツール（`mcp-safe-shell-server`）を使用すること。
    *   `run_command` は、対話的入力が必要な場合や `safe-shell` で実行不可能な場合にのみ、例外的に使用を許可する。
3.  **診断スキップの禁止 (No Skipping Diagnostics):**
    *   コミット前に `self_diagnostic.py` の実行を省略してはならない。「軽微な修正だから大丈夫」という判断は認められない。
4.  **自己判断によるルール変更禁止:**
    *   ユーザーの明示的な承認なしに `GEMINI.md` のルールを緩和・削除してはならない。


---

## 2. コミュニケーションと言語 (Communication & Language)

1.  **日本語の使用:**
    *   ユーザーとの会話、ドキュメント、コミットメッセージ、コードコメントは原則として**日本語**を使用する。
2.  **ダークモード配慮:**
    *   出力は見やすさを重視し、文字色は白（または高輝度）を保つこと。HTMLカラーコードは使用禁止。

---

## 3. 環境とツール (Environment & Tools)

1.  **仮想環境の利用:**
    *   すべての Python コマンドは `/home/irom/project-stock2/venv` の仮想環境を使用すること。
    *   `source .../activate` または フルパス指定を行うこと。
2.  **禁止事項:**
    *   システムの `/usr/bin/python3` を直接使用してはならない。

---

## 4. 長期記憶の管理 (Memory Management)

本プロジェクトでは、`memory-server` を使用して、プロジェクト固有の知見やユーザーの好みを永続化する。

1.  **知見のインポート (Sync-In):**
    *   作業開始時、または環境構築時には、必ず `memory-server.import_memories` ツールを使用して `.agent/memory/memory_dump.json` から知見を読み込むこと。
2.  **記憶の記録 (Memory Creation):**
    *   重要な設計判断、特定のエラーへの対処法、ユーザーからの重要なフィードバック、またはプロジェクト固有の命名規則などを発見・決定した際は、積極的に `memory-server.create_memory` で記録すること。
3.  **知見のエクスポート (Sync-Out):**
    *   作業完了（コミット）前には、必ず `memory-server.export_memories` を実行し、`.agent/memory/memory_dump.json` を最新状態に更新すること。
    *   これにより、知見がバージョン管理され、他の環境でも共有可能となる。

---

## 5. 完了の定義 (Definition of Done)

エージェントが各タスクまたは修正を「完了」とし、ユーザーに報告 (`notify_user`) する前には、以下のチェックリストを**絶対条件**として満たさなければならない。

1.  **Gitステータスの確認 (Clean Status):**
    *   `git status` を実行し、未コミットの変更ファイル（Modified / Untracked）が残っていないことを確認する。
    *   特にサブモジュール内 (`stock-analyzer4/` 等) の変更放置は厳禁とする。
2.  **リモート同期の完了 (Remote Sync):**
    *   ローカルでのコミットのみで満足せず、必ず `git push` まで完了していることを確認する。
    *   ユーザーの実行環境（Colab等）はリモートリポジトリを参照するため、プッシュされていない修正は「存在しない」と同義である。
3.  **最終動作確認 (Final Verification):**
    *   プッシュ直前の状態で `pytest` や診断スクリプトがパスしていることを最終確認する。

**「ローカルで直った」は完了ではない。「ユーザーの手元で動く状態になった」ことこそが完了である。**

---

## 5. 無限修正ループの防止 (Infinite Loop Prevention)



## 5. 無限修正ループの防止 (Infinite Loop Prevention)

同一の修正が**2回以上**失敗した場合は、直ちに作業を停止し、**「代替案の提示」** または **「根本原因の再調査」** を行うこと。盲目的な再試行は禁止する。

---

## 6. ドキュメント・ブログ管理 (Documentation & Blog)

1.  **ブログ記事の格納場所:**
    *   ブログネタや記事ドラフトは必ず **`/home/irom/dev/gemini-docs/projects/<project_name>/blog/drafts/`** ディレクトリに格納すること。
    *   `docs/` 配下には技術仕様書や設計資料のみを置く。

<!-- Notification Test: 2026-01-21 11:39 -->
<!-- Notification Test v2: 2026-01-21 13:03 -->
<!-- Notification Test v3: 2026-01-21 13:13 -->
<!-- Discord MCP Integration Test: 2026-01-21 14:01 -->
