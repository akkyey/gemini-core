#!/bin/bash
# .gemini/scripts/git-hooks/pre-commit
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ gemini-core ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚
# å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® .git/hooks/pre-commit ã«ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

echo "ğŸ›¡ï¸  [GEMINI-Hook] Starting Compliance & Quality Gate..."

# 1. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ•´åˆæ€§ã®ãƒã‚§ãƒƒã‚¯ (Documentation Freshness)
# full_context ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Šã€ã‹ã¤æœªã‚¹ãƒ†ãƒ¼ã‚¸(å¤‰æ›´ã‚ã‚Š)ã®å ´åˆã¯è­¦å‘Šorãƒ–ãƒ­ãƒƒã‚¯
if [ -d "full_context" ]; then
    if ! git diff --quiet -- full_context/; then
        echo "âš ï¸  [Warning] 'full_context/' has changes that are not staged."
        echo "   Please confirm if documentation is up-to-date."
        # Contextã®æ›´æ–°æ¼ã‚Œã¯è‡´å‘½çš„ã§ã¯ãªã„ã®ã§Warningã§ç•™ã‚ã‚‹é‹ç”¨ã‚‚ã‚¢ãƒªã ãŒã€
        # å³å¯†ã«ã™ã‚‹ãªã‚‰ã“ã“ã§ exit 1
    fi
fi

# 2. ç¦æ­¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ (ç°¡æ˜“ç‰ˆ)
# ä»®å®Ÿè£…: "TODO: FIX NOW" ã¨ã„ã†å¼·ã„æ®‹ç½®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Œã°ãƒ–ãƒ­ãƒƒã‚¯
if git diff --cached | grep -q "TODO: FIX NOW"; then
    echo "âŒ [Error] Forbidden pattern 'TODO: FIX NOW' found in staged changes."
    exit 1
fi

# 3. ãƒªãƒ³ãƒˆãƒ»ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«å®šç¾©ãŒã‚ã‚Œã°)
# package.json ãŒã‚ã‚Šã€testã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
if [ -f "package.json" ]; then
    if grep -q '"test":' package.json; then
        echo "ğŸ§ª [Test] Running npm test..."
        # å®Ÿè¡Œæ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹ãŸã‚ã€CIã®ã‚ˆã†ãªãƒ•ãƒ«ãƒ†ã‚¹ãƒˆã§ã¯ãªãã€é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ç­‰ãŒç†æƒ³ã ãŒ
        # ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã« test ã‚’å‘¼ã¶ï¼ˆé‡ã‘ã‚Œã°å¾Œã§èª¿æ•´ï¼‰
        # npm test
        # â€» ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã®ãƒ‡ãƒ¢ã®ãŸã‚ã€ä¸€æ—¦ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰ã—ã¦ãŠãã¾ã™
        :
    fi
fi

echo "âœ… [GEMINI-Hook] Gate Passed. Proceeding to commit."
exit 0
