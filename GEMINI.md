# エージェント行動規範 (Agent Behavior Protocol)

## 1. 原則とエージェントスキル (Principles & Agent Skills)

本プロジェクトでは、定型的な作業の品質とルール遵守を保証するため、**「エージェントスキル (Agent Skills)」の使用を義務付けている。**
エージェントは、以下の状況下では**必ず対応するスキルを使用し、その手順に従うこと。**

また、スキルを使用する際は、タスクの冒頭で以下のように**明示的に宣言**すること。
> 🤖 **【スキル発動】 `skill_name`**

### セッション開始ルール (Session Start)

**会話開始時は、必ず `.gemini` サブモジュールを最新化すること。**

```bash
/sync-gemini
```

または手動で:
```bash
cd .gemini && git pull origin main && cd ..
```

> [!NOTE]
> これにより `anti_patterns.md`、スキル定義、ワークフローが最新状態に同期されます。

### スキルの改善と新規提案 (Continuous Improvement)

作業を通じて「この手順はスキル化した方が効率的だ」や「既存スキルの手順に不備がある」と気づいた場合、**積極的にユーザーへ改善や新規作成を提案すること。**
現状維持に満足せず、開発プロセスの進化に貢献せよ。

### 必須使用スキル一覧 (Mandatory Skills)

状況に応じて、以下のスキルの使用を徹底すること。
各スキルの詳細は `.agent/skills/<skill_name>/SKILL.md` を参照せよ。

1.  **機能実装・修正 (`feat_implementer`):**
    *   **用途:** 新機能実装、バグ修正、ドキュメント作成。
    *   **カバー範囲:** ブランチ作成、計画書(Plan)、承認フロー、実装、履歴記録(History)、自己診断。

2.  **品質管理・テスト (`quality_guard`):**
    *   **用途:** カバレッジ向上、Lintエラー修正、静的解析。
    *   **カバー範囲:** `vitest` / `jest` (Coverage), `eslint`, `prettier`, `tsc`。

3.  **不具合報告 (`trouble_reporter`):**
    *   **用途:** エラー、テスト失敗、バグ検知時。
    *   **カバー範囲:** 自動修正の禁止、レポート作成(`trouble/`)、指示待ちフロー。

4.  **実装前の合意形成 (Approval Before Implementation):**
    *   **厳守:** コードを書き始める前に、必ず「実現方法（Implementation Plan）」を提示し、ユーザーの明示的な許可を得ること。
    *   **禁止:** 「修正します」と言って、事前の説明なしにファイル編集を開始すること。
    *   **例外:** 自明なバグ修正（Typo等）や、ユーザーから「任せる」と言われた場合を除く。

5.  **コンテキスト同期 (`context_syncer`):**
    *   **用途:** タスク完了時、ドキュメント整備。
    *   **カバー範囲:** `full_context` 生成、`task.md` / `backlog.md` 更新、アーカイブ処理。

6.  **Gitコミット (`git_committer`):**
    *   **用途:** リポジトリへの変更保存。
    *   **カバー範囲:** シェルインジェクション防止（一時ファイル使用）、メッセージ規約遵守。

7.  **品質ゲートキーパー (`quality_gatekeeper`):**
    *   **用途:** コミット前の品質検閲。
    *   **カバー範囲:** Radonによる複雑度(CC)・保守性(MI)の計測、リファクタリング勧告。

### 1.1 禁止事項とアンチパターン (Prohibited Actions & Anti-Patterns)

以下の行為は、プロジェクトの品質と安全性を著しく損なうため、**例外なく禁止する。**

1.  **Gitコマンドの直接実行禁止 (No Direct Git Commit):**
    *   `run_command` 等を使って `git commit -m ...` を直接実行してはならない。必ず `git_committer` スキルの手順（一時ファイル作成等）を経由すること。
2.  **診断スキップの禁止 (No Skipping Diagnostics):**
    *   コミット前に `npm test` 及び `npm run build` を含む診断手順を省略してはならない。「軽微な修正だから大丈夫」という判断は認められない。
3.  **自己判断によるルール変更禁止:**
    *   ユーザーの明示的な承認なしに `GEMINI.md` のルールを緩和・削除してはならない。


---

## 2. コミュニケーションと言語 (Communication & Language)

1.  **日本語の使用:**
    *   ユーザーとの会話、ドキュメント、コミットメッセージ、コードコメントは原則として**日本語**を使用する。
2.  **ダークモード配慮:**
    *   出力は見やすさを重視し、文字色は白（または高輝度）を保つこと。HTMLカラーコードは使用禁止。

---

## 3. 環境とツール (Environment & Tools)

1.  **環境の利用:**
    *   すべてのビルド・実行は `node_modules` にインストールされた依存関係を使用し、最新の `npm` または `npx` コマンドを通じて実行すること。
2.  **禁止事項:**
    *   プロジェクト外のグローバルな `tsc` を直接常用してはならない（`npx tsc` 等を使用）。

## 4. 完了の定義 (Definition of Done)

エージェントが各タスクまたは修正を「完了」とし、ユーザーに報告 (`notify_user`) する前には、以下のチェックリストを**絶対条件**として満たさなければならない。

1.  **Gitステータスの確認 (Clean Status):**
    *   `git status` を実行し、未コミットの変更ファイル（Modified / Untracked）が残っていないことを確認する。
    *   特にサブモジュール内 (`stock-analyzer4/` 等) の変更放置は厳禁とする。
2.  **リモート同期の完了 (Remote Sync):**
    *   ローカルでのコミットのみで満足せず、必ず `git push` まで完了していることを確認する。
    *   ユーザーの実行環境（Colab等）はリモートリポジトリを参照するため、プッシュされていない修正は「存在しない」と同義である。
3.  **最終動作確認 (Final Verification):**
    *   プッシュ直前の状態で `npm test` やビルド、診断スクリプトがパスしていることを最終確認する。

**「ローカルで直った」は完了ではない。「ユーザーの手元で動く状態になった」ことこそが完了である。**

---

## 5. 無限修正ループの防止 (Infinite Loop Prevention)


同一の修正が**2回以上**失敗した場合は、直ちに作業を停止し、**「代替案の提示」** または **「根本原因の再調査」** を行うこと。盲目的な再試行は禁止する。

---

## 6. ドキュメント・ブログ管理 (Documentation & Blog)

1.  **ブログ記事の格納場所:**
    -   ブログネタや記事ドラフトは、各プロジェクトの **`blog/`** ディレクトリ（親リポジトリの場合は `mcp-servers/blog/`）に格納すること。
    -   `docs/` 配下には技術仕様書や設計資料のみを置く。

2.  **ブログネタの逐次記録 (Continuous Blog Idea Capture):**
    *   **「一区切り」ごとに、開発の経緯、苦労した点、得られた知見を `blog/ideas/YYYY-MM-DD_ideas.md` に追記すること。**
    *   特に、プロジェクトの移行、言語の変更、環境構築のトラブルなどの「ライブ感」のある情報を重視せよ。
    *   タスクの完了報告 (`notify_user`) を行う前に、必ずこの記録が更新されているか確認すること。

---

## 7. 長期記憶 (Memory Management)

長期記憶MCP (`memory-server`) は、未来の判断を助ける知見を蓄積・活用するための重要インフラである。

### 7.1 設計思想とデータ構造
*   **目的:** 全履歴の保存ではなく、「教訓」や「判断基準」の永続化。
*   **カテゴリ:** `user_preference` (好み), `project_insight` (暗黙知), `task_history` (作業履歷), `code_pattern` (実装パターン) を厳格に使い分ける。
*   **重要度:** `importance` (1-5) を設定し、重要なアーキテクチャ決定が検索上位に来るようにする。

### 7.2 エージェント行動規範 (Memory Operations)

**A. 記憶の検索 (Recall)**
新しいタスクの着手前、または未知のモジュール解析時には、必ず `search_memories` を実行し、過去のハマりどころやユーザーの好みを照会すること。
*   例: 「このプロジェクトのテスト方針は？」

**B. 記憶の定着 (Storage)**
実装計画が完了し、コードが動作した際、その過程で得た「非自明な知見」を `create_memory` で保存すること。
*   **禁止:** 膨大な一時ログの保存。
*   **禁止:** 膨大な一時ログの保存。
*   **推奨:** 要約された「教訓」（例：「FTS5のクエリはサニタイズが必要」）。
*   **義務 (Failure Recording):** バグ発生時、規約違反の指摘時、または `trouble_reporter` 使用時は、必ずその**原因と再発防止策**を `tag: ["failure", "anti_pattern"]` 付きで記録すること。

**C. 成果の昇格 (Promotion)**
*   **ドキュメント:** 永続的な仕様は `docs/` へ (Git管理)。
*   **記憶:** 開発の癖や文脈は `memory-server` へ。

**D. 運用・保守**
*   **可搬性:** 定期的に `export_memories` を実行し、JSONをGit管理下 (`docs/memory_backup.json` 等) に保存することで同期を補完する。
*   **整理:** 不要な記憶は `delete_memory` で整理し、必要に応じて `VACUUM` (SQLite最適化) を検討する。

*   **整理:** 不要な記憶は `delete_memory` で整理し、必要に応じて `VACUUM` (SQLite最適化) を検討する。

---

## 8. コンテキスト管理とガバナンス (Context Management & Governance)

本プロジェクトでは、`gemini-core` リポジトリを「唯一の正解（Single Source of Truth）」とし、全プロジェクトのルールとコンテキストを一元管理する。

### 8.1 司令塔構造 (Centralized Command)
*   **司令塔 (Core):** `/home/irom/dev/gemini-core`
    *   **役割:** 全体方針、ルール (`GEMINI.md`)、スキル、共有ワークフローの策定と管理。
    *   **権限:** **書き込み可能 (Read/Write)**。ルールの変更は必ずここで行う。
*   **現場 (Projects):** `mcp-servers`, `project-stock2`, `salesforce` 等
    *   **役割:** ルールの適用と遵守。
    *   **権限:** **読み取り専用 (Read-Only)**。`.gemini` サブモジュール内の直接編集は禁止され、物理的にブロック（`chmod a-w`）される。

### 8.2 運用フロー (Operational Workflow)
1.  **ルール変更:**
    *   `gemini-core` リポジトリでファイルを修正し、コミット・Pushする。
2.  **全軍適用:**
    *   任意のプロジェクトで `/sync-gemini` ワークフローを実行する。
    *   全プロジェクトのサブモジュールが更新され、読み取り専用モードで再配置される。

### 8.3 新規プロジェクトの作成
新規プロジェクトを作成する際は、必ず `.gemini` をサブモジュールとして追加し、司令塔の配下に置くこと。

```bash
git submodule add https://github.com/akkyey/gemini-core.git .gemini
/sync-gemini  # 初期化・固定化
```
