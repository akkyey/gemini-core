---
name: integrity_verifier
description: リファクタリングやパフォーマンス改善時に、変更前後で出力結果が完全一致することを保証するための検証スキル。
---

# Integrity Verifier Skill

GEMINI.md の「改造時の結果整合性検証」ポリシーに準拠するためのスキルです。
ロジックの書き換えを行う際は、必ずこの手順で安全性を担保してください。

## 作業フロー

### 1. ベースライン取得 (Baseline)

1.  **現状の保存**:
    - 変更前のコードで処理を実行し、出力結果（CSV, JSON, print出力など）を一時ファイルに保存します。
    - 保存先例: `temp_baseline_output.txt`
      ```bash
      python src/target_script.py > temp_baseline_output.txt
      ```

### 2. 変更適用 (Modification)

1.  **コード修正**:
    - リファクタリングや最適化のコード変更を適用します。

### 3. キャンディデイト取得 (Candidate)

1.  **新環境での実行**:
    - 変更後のコードで**全く同じ入力条件**で処理を実行し、結果を保存します。
    - 保存先例: `temp_candidate_output.txt`
      ```bash
      python src/target_script.py > temp_candidate_output.txt
      ```

### 4. 比較検証 (Verification)

1.  **差分チェック**:
    - `diff` コマンド等で比較します。
      ```bash
      diff temp_baseline_output.txt temp_candidate_output.txt
      ```
    - **完全一致**すれば合格です。

4.  **構造的健全性の確認 (Structural Quality)**:
    - **疎結合化の推進**: 引数が多すぎる、または断片的な情報を渡している箇所を、明示的なデータ構造（Task Spec JSON等）に集約できないか検討します。
    - **危険なデフォルトの排除**: 論理エラーを隠蔽する可能性のあるデフォルト引数（例: `strategy="Balanced"`）を削除し、必須引数化または例外送出に変更することを推奨します。
    - **サブプロセス境界の検証**: サブプロセス呼び出しを伴うリファクタリングでは、実際に正しいコマンドライン引数やファイルが渡されているかを、`quality_guard` スキルのシナリオテストで検証します。

### 5. 報告と合意 (Agreement)

1.  **差異の報告**:
    - 差異が「許容されるもの（例: タイムスタンプの違い、浮動小数点の末尾）」か「構造的改善による意図的な変更」か、あるいは「バグ」かを分析します。
    - **報告**: ユーザーに「出力に差異（または構造的変更）があります」と報告し、許容範囲内かどうかの判断を仰ぎます。**勝手にOKとしないこと。**

### 6. クリーンアップ

- 一時ファイル（`temp_...`）を削除します。
