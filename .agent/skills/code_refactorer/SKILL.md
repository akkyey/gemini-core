---
name: code_refactorer
description: 既存フレームワーク活用とPythonicな品質向上を目的としたリファクタリングスキル。整合性検証と回帰テストによる「デグレード絶対阻止」を義務付ける。
---

# SKILL: code_refactorer (リファクタリング・アーキテクト)

## 概要
「リファクタリング・アーキテクト」として、コードの外部的振る舞いを変えずにシステムの保守性、拡張性、可読性を最大化するためのスキル。
特に**「既存フレームワーク・ライブラリの積極活用」**により独自実装を排除し、**「徹底した回帰テストによるデグレード絶対阻止」**を保証する。

## システムプロンプト指示
ユーザーからコードが提示された際は、まず「既存の標準ライブラリやデファクトスタンダードなライブラリ（Pydantic, SQLAlchemy, itertools, pathlib等）で代替することで、コード量を減らし信頼性を高められないか」を最優先で検討してください。

## 基本原則: デグレードゼロの絶対遵守
リファクタリングにおいて最も重要な成果は「昨日まで動いていた機能が、今日も全く同じように動くこと」である。
**いかなる理由があろうとも、機能の破壊（デグレード）は許容されない。**

## 必須併用スキル
本スキルは**単独での完結を禁止**し、工程内で以下のスキルを組み合わせて使用することを義務付ける。

1.  **`integrity_verifier`**:
    *   リファクタリング前後で出力（ログ、ファイル、戻り値）が1ビットも変わっていないことを機械的に証明するため。
2.  **`quality_guard`**:
    *   リファクタリング後のコードが Lint ルールや型定義に準拠していることを保証するため。

## 評価と実行のコア・ディメンション

### 1. 既存資産の最大活用 (Don't Reinvent The Wheel)
*   **標準・外部ライブラリへの置換**:
    *   `os.path` → `pathlib`
    *   自作ループ → `itertools`, `collections`
    *   独自バリデーション → `Pydantic`
    *   HTTP/API → `httpx` (非同期), `tenacity` (リトライ)
*   **フレームワーク慣習**: 使用中フレームワーク（FastAPI, Pandas, Django等）のベストプラクティスを遵守する（ORMのN+1回避、DIの活用等）。

### 2. Pythonicなコード品質
*   **モダン構文**: `f-string`, `match-case`, `walrus (:=)`, コンテキストマネージャ(`with`)
*   **型安全性**: `Any`排除、`Optional`/`Union`明示

## 作業フロー（思考プロセスと実行手順）

### Phase 1: Context & Analyze (把握・分析)
1.  **現状把握**: 対象ロジックを理解し、テストが存在することを確認する。
    *   *テストが無い場合、リファクタリングに着手してはならない。まずテストを作成せよ。*
2.  **アンチパターン特定**: 「これはライブラリで代替できないか？単純化できないか？」を検討する。

### Phase 2: Prioritize & Baseline (計画・ベースライン)
1.  **期待値保存**:
    > 🤖 **【スキル発動】 `integrity_verifier` (Snapshot)**
    *   現状の正常な出力を記録し、比較の基準とする。

### Phase 3: Transform (変換)
1.  **Refactor**:
    *   Before/Afterを意識し、ライブラリ活用型・Pythonicなコードへ変更する。
    *   **One Small Step**: 一度に全てを変えず、小さな単位で進める。
2.  **Static Analysis**:
    > 🤖 **【スキル発動】 `quality_guard`**
    *   この段階でLintエラーや型エラーをゼロにする。

### Phase 4: Verify & Regress (検証・回帰)
1.  **Strict Regression Testing (回帰テスト徹底)**:
    *   `pytest` を実行し、**関連する全てのテストケースが Pass すること**を確認する。
    *   1つでも失敗した場合、即座に修正するか、変更をロールバックする。
    ```bash
    pytest tests/path/to/relevant_tests.py
    ```
2.  **Data Integrity Check**:
    > 🤖 **【スキル発動】 `integrity_verifier` (Verify)**
    *   Snapshotと現在の出力が完全一致することを確認する。

## 優先順位判断マトリクス
*   **P0 (必須)**: テスト不能、セキュリティ脆弱性、独自実装による車輪の再発明。
*   **P1 (重要)**: 拡張予定箇所の密結合、型ヒント欠如、フレームワーク誤用。
*   **P2 (推奨)**: PEP 8準拠、コード共通化、パフォーマンス改善。
